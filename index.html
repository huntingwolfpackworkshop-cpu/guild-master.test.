<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚®ãƒ«ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ï¼šã‚­ãƒ£ãƒ©åˆ¥ã‚¢ã‚¤ã‚³ãƒ³ç‰ˆ</title>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆå¤‰æ›´ãªã—ï¼‰ */
        body { font-family: 'Hiragino Sans', 'Meiryo', sans-serif; background: #1a1c2c; color: #f4f4f4; padding: 20px; }
        .container { max-width: 950px; margin: auto; background: #212331; padding: 20px; border-radius: 15px; border: 1px solid #3d415e; }
        .header-ui { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #2a2d3e; padding: 15px; border-radius: 10px; }
        .stat-badge { padding: 10px 20px; border-radius: 8px; font-weight: bold; text-align: center; }
        .turn-badge { background: #7289da; color: white; }
        .money-badge { background: #ffcc00; color: #333; }
        
        .quest-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .quest-card { background: #3d415e; padding: 15px; border-radius: 10px; width: 33%; border: 3px solid transparent; cursor: pointer; transition: 0.2s; position: relative; }
        .quest-card.selected { border-color: #ffb86c; background: #4e527a; }
        .q-reward { position: absolute; top: 10px; right: 10px; background: #cd7f32; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }
        
        .adventurer-list { display: flex; gap: 10px; margin-bottom: 20px; }
        .adv-card { 
            background: #fdfdfd; color: #282a36; padding: 15px; border-radius: 8px; 
            width: 33%; cursor: pointer; border: 4px solid transparent; transition: 0.2s; 
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .adv-card.selected { border-color: #50fa7b; transform: translateY(-3px); }
        .adv-card.injured { background: #f8d7da !important; color: #721c24 !important; }
        .adv-card.resting { background: #e2e3e5 !important; color: #383d41 !important; opacity: 0.8; cursor: not-allowed !important; }
        
        .adv-info { flex: 1; }
        .adv-name { font-weight: bold; font-size: 1.2em; display: block; margin-bottom: 5px; }

        .status-icon-box {
            width: 70px; height: 70px; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            margin-left: 10px; overflow: hidden; background: rgba(0,0,0,0.05);
        }
        .status-icon-box img { width: 100%; height: 100%; object-fit: cover; }

        .adv-status-list { font-size: 0.85em; margin: 8px 0; padding: 0; list-style: none; border-top: 1px solid rgba(0,0,0,0.1); padding-top: 5px; }
        .adv-status-list li { display: flex; justify-content: space-between; }

        .controls { background: #2a2d3e; padding: 20px; border-radius: 10px; text-align: center; }
        .prediction-area { margin-bottom: 15px; padding: 10px; border-radius: 5px; background: #1a1c2c; min-height: 24px; }
        .rate-display { font-size: 1.4em; font-weight: bold; }
        
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; }
        .btn-main { background: #50fa7b; color: #282a36; font-size: 1.1em; width: 250px; }
        .btn-main:disabled { background: #555; color: #888; }
        .btn-pass { background: #7f8c8d; color: white; margin-left: 10px; }
        
        .action-btns { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .btn-heal { background: #ffcc00; color: #333; font-size: 0.75em; padding: 5px; }
        .btn-boost { background: #3498db; color: white; font-size: 0.75em; padding: 5px; }

        #log { margin-top: 20px; height: 130px; overflow-y: auto; background: #0c0d15; padding: 15px; border-radius: 5px; color: #a0a0a0; font-size: 0.85em; border: 1px solid #3d415e; }
        .success { color: #50fa7b; } .failure { color: #ff5555; }
        #overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; flex-direction:column; justify-content:center; align-items:center; text-align: center;}
    </style>
</head>
<body>

<div id="overlay">
    <h1 id="over-title"></h1>
    <p id="over-msg"></p>
    <button onclick="location.reload()" style="background:#7289da; color:#fff;">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
</div>

<div class="container">
    <div class="header-ui">
        <div class="stat-badge turn-badge">ğŸ“… æ®‹ã‚Š: <span id="turn-display">10</span> ã‚¿ãƒ¼ãƒ³</div>
        <h2 style="margin:0; color:#7289da;">ğŸ›¡ï¸ Guild Manager</h2>
        <div class="stat-badge money-badge">ğŸ’° éŠ…è²¨: <span id="money-display">0</span> / 20</div>
    </div>

    <div class="quest-container" id="quest-list"></div>
    <div class="adventurer-list" id="adv-list"></div>

    <div class="controls">
        <div class="prediction-area" id="prediction">æº–å‚™ã‚’æ•´ãˆã¦ãã ã•ã„</div>
        <button class="btn-main" id="exec-btn" onclick="execute()" disabled>æ´¾é£ã‚’é–‹å§‹ã™ã‚‹</button>
        <button class="btn-pass" onclick="passTurn()">ä½•ã‚‚ã—ãªã„ï¼ˆå…¨å“¡ä¼‘æ†©ï¼‰</button>
    </div>

    <div id="log">>> å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å°‚ç”¨ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚</div>
</div>

<script>
    let currentTurn = 10;
    let totalMoney = 0;
    let selectedQuestIdx = null;
    let selectedAdvIds = [];
    
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿è¨­å®š
    const adventurers = [
        { id: 0, name: "ãƒ–ãƒ«", fileKey: "bull", atk: 2, mag: 1, spi: 1, vit: 2, isInjured: false, isResting: false, boostedThisTurn: false },
        { id: 1, name: "ã‚·ã‚§ãƒªãƒ¼", fileKey: "sherry", atk: 1, mag: 2, spi: 2, vit: 1, isInjured: false, isResting: false, boostedThisTurn: false },
        { id: 2, name: "ã‚³ãƒ‹ãƒ¼", fileKey: "connie", atk: 1, mag: 1, spi: 2, vit: 2, isInjured: false, isResting: false, boostedThisTurn: false }
    ];

    const questPool = [
        { name: "é­”ç£è¨ä¼", stat: "atk", sName: "æ”»æ’ƒåŠ›" },
        { name: "éºè·¡è§£èª­", stat: "mag", sName: "è¡“åŠ›" },
        { name: "ç¥ˆç¥·å„€å¼", stat: "spi", sName: "ä¿¡ä»°åŠ›" },
        { name: "å¯†æ—èª¿æŸ»", stat: "vit", sName: "ç”Ÿå‘½åŠ›" }
    ];
    let currentQuests = [];

    function init() { generateQuests(); render(); }

    function generateQuests() {
        currentQuests = [];
        for(let i=0; i<3; i++) {
            let q = {...questPool[Math.floor(Math.random()*questPool.length)]};
            q.target = Math.floor(Math.random()*5) + 1;
            q.reward = q.target;
            currentQuests.push(q);
        }
        selectedQuestIdx = null; selectedAdvIds = [];
    }

    // ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆã‚¿ã‚¤ãƒã«å¯¾å¿œï¼‰
    function getIconPath(adv) {
        const key = adv.fileKey;
        if (adv.isInjured) {
            // ã‚³ãƒ‹ãƒ¼ã®ã‚¿ã‚¤ãƒ(infured)ã«å¯¾å¿œ
            return key === "connie" ? "connie.injured.png" : `${key}.injured.png`;
        }
        if (adv.isResting) {
            // ã‚·ã‚§ãƒªãƒ¼ã®ã‚¿ã‚¤ãƒ(sherry,resting)ã«å¯¾å¿œ
            return key === "sherry" ? "sherry.resting.png" : `${key}.resting.png`;
        }
        return `${key}.ready.png`;
    }

    function calculateRate() {
        if (selectedQuestIdx === null || selectedAdvIds.length === 0) return null;
        const q = currentQuests[selectedQuestIdx];
        const totalStat = selectedAdvIds.reduce((s, id) => s + adventurers[id][q.stat], 0);
        let diff = totalStat - q.target;
        let calcDiff = diff < 0 ? diff * 2 : diff;
        return Math.max(0, Math.min(100, (calcDiff * 20) + 80));
    }

    function render() {
        const qDiv = document.getElementById('quest-list');
        qDiv.innerHTML = currentQuests.map((q, i) => `
            <div class="quest-card ${selectedQuestIdx===i?'selected':''}" onclick="selectQuest(${i})">
                <div class="q-reward">ğŸ’°${q.reward}</div>
                <div style="font-weight:bold;">${q.name}</div>
                <div style="font-size:0.8em; color:#ffb86c; margin-top:10px;">è¦æ±‚: ${q.sName} ${q.target}</div>
            </div>
        `).join('');

        const aDiv = document.getElementById('adv-list');
        aDiv.innerHTML = adventurers.map(a => {
            const iconPath = getIconPath(a);
            return `
                <div class="adv-card ${a.isInjured?'injured':(a.isResting?'resting':'')} ${selectedAdvIds.includes(a.id)?'selected':''}" onclick="selectAdv(${a.id})">
                    <div class="adv-info">
                        <span class="adv-name">${a.name}</span>
                        <ul class="adv-status-list">
                            <li><span>æ”»æ’ƒåŠ›</span> <span>${a.atk}</span></li>
                            <li><span>è¡“åŠ›</span> <span>${a.mag}</span></li>
                            <li><span>ä¿¡ä»°åŠ›</span> <span>${a.spi}</span></li>
                            <li><span>ç”Ÿå‘½åŠ›</span> <span>${a.vit}</span></li>
                        </ul>
                        <div class="action-btns">
                            ${a.isInjured?`<button class="btn-heal" onclick="event.stopPropagation(); heal(${a.id})">æ²»ç™‚ (ğŸ’°1)</button>`:''}
                            <button class="btn-boost" onclick="event.stopPropagation(); boost(${a.id})" ${(totalMoney<2 || a.boostedThisTurn || a.isInjured)?'disabled':''}>å¼·åŒ– (ğŸ’°2)</button>
                        </div>
                    </div>
                    <div class="status-icon-box">
                        <img src="${iconPath}" alt="${a.name}" onerror="this.style.display='none'">
                    </div>
                </div>
            `;
        }).join('');

        const rate = calculateRate();
        const predDiv = document.getElementById('prediction');
        if (rate !== null) {
            predDiv.innerHTML = `äºˆæƒ³æˆåŠŸç‡: <span class="rate-display" style="color:${rate >= 80 ? '#50fa7b' : (rate >= 50 ? '#ffb86c' : '#ff5555')}">${rate}%</span>`;
        } else {
            predDiv.innerHTML = "ã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„";
        }

        document.getElementById('turn-display').innerText = currentTurn;
        document.getElementById('money-display').innerText = totalMoney;
        document.getElementById('exec-btn').disabled = (rate === null);
    }

    function selectQuest(i) { selectedQuestIdx = i; render(); }
    function selectAdv(id) {
        if(adventurers[id].isInjured || adventurers[id].isResting) return;
        const idx = selectedAdvIds.indexOf(id);
        if(idx > -1) selectedAdvIds.splice(idx,1);
        else if(selectedAdvIds.length < 3) selectedAdvIds.push(id);
        render();
    }

    function heal(id) { if(totalMoney >= 1) { totalMoney--; adventurers[id].isInjured = false; render(); } }
    function boost(id) {
        if(totalMoney >= 2 && !adventurers[id].boostedThisTurn) {
            totalMoney -= 2;
            adventurers[id].atk++; adventurers[id].mag++; adventurers[id].spi++; adventurers[id].vit++;
            adventurers[id].boostedThisTurn = true;
            render();
        }
    }

    function passTurn() { addLog(`<span style="color:#7289da">>> å…¨å“¡ä¼‘æ¯ã€‚</span>`); processTurnEnd([]); }

    function execute() {
        const rate = calculateRate();
        const success = (Math.random()*100) < rate;
        const q = currentQuests[selectedQuestIdx];
        const names = selectedAdvIds.map(id => adventurers[id].name).join('ãŸã¡');
        if(success) { totalMoney += q.reward; addLog(`<span class="success">ã€æˆåŠŸã€‘</span> ${names}ãŒ${q.name}ã‚’é”æˆï¼ ğŸ’°+${q.reward}`); }
        else { selectedAdvIds.forEach(id => adventurers[id].isInjured = true); addLog(`<span class="failure">ã€å¤±æ•—ã€‘</span> ${names}ãŒè² å‚·ã—ã¾ã—ãŸï¼`); }
        processTurnEnd(selectedAdvIds);
    }

    function processTurnEnd(justDispatchedIds) {
        adventurers.forEach(a => { a.isResting = false; a.boostedThisTurn = false; });
        justDispatchedIds.forEach(id => adventurers[id].isResting = true);
        currentTurn--;
        if(totalMoney >= 20) endGame(true);
        else if(currentTurn <= 0) endGame(false);
        else { generateQuests(); render(); }
    }

    function addLog(msg) { const log = document.getElementById('log'); log.innerHTML = `<div>${msg}</div>` + log.innerHTML; }

    function endGame(win) {
        const ov = document.getElementById('overlay'); ov.style.display = 'flex';
        document.getElementById('over-title').innerText = win ? "MISSION CLEAR!" : "GAME OVER";
        document.getElementById('over-msg').innerText = win ? `ç›®æ¨™é”æˆï¼åé–€ã‚®ãƒ«ãƒ‰ã®èª•ç”Ÿã§ã™ï¼` : `è³‡é‡‘ä¸è¶³ã«ã‚ˆã‚Šã‚®ãƒ«ãƒ‰ã¯è§£æ•£ã—ã¾ã—ãŸã€‚`;
    }

    init();
</script>
</body>
</html>